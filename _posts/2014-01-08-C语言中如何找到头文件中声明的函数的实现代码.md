---
layout: post
title: C语言中如何找到头文件中声明的函数的实现代码
---
这是我这两天想到的一个问题，后来上网查了查,现在整理一下。

我们知道，编写C程序的时候常常会包含一些自带的头文件，比如*stdio.h*，并且我们自己经常需要写头文件。如下为两个.c文件file1.c、file2.c和一个.h文件file1.h,
其中file1.h中是函数声明，file1.c中是函数实现，file2.c包含了file1.h头文件并调用了那个函数。

{%  highlight c %}
//file1.h
void ShowHello();
{% endhighlight %}

{%  highlight c %}
//file1.c
#include <stdio.h>
//#include "file1.h"
void ShowHello(){
	printf("hello shengming\n");
}
{% endhighlight %}

{%  highlight c %}
//file2.c
#include <stdio.h>
#include "file1.h"
int main(int argc, const char *argv[])
{
	ShowHello();
	return 0;
}
{% endhighlight %}

我的问题是，file2.c包含file1.h头文件后，在程序执行过程中是如何找到file1.c中的ShowHello()的实现代码？是不是到和.h文件同名的.c文件中查找的呢?后来发现不是这样的，
简单来说，程序在编译的过程中并不关心函数的实现在哪里，只知道在函数调用之前至少存在函数的声明即可，真正需要函数实现的地方是在程序链接的时候。所以关于我的疑问的
解答就是，.h文件和.c文件的文件名不需要有半毛钱的关系，在编译的链接阶段，链接器到之前编译生成的目标文件（.o、.obj）中查找头文件声明的函数的实现部分，进而生成可执行文件。

编译器的编译分为三个阶段：

1. 预处理阶段，编译阶段，链接阶段。在预处理阶段，编译器以.c文件为一个编译单元，如果.c文件中包含#include宏，那么就将包含的.h文件的代码替换#include
语句,形成一个“中间的C文件”;
2. 在编译阶段，为“中间的C文件”中的变量函数等分配空间，将各函数编译为二进制码，按照特定格式和标准生成目标文件；
3. 在链接阶段，链接器到目标文件中查找各个函数的实现，并拼接为一个可执行程序。

既然include头文件的语句会被头文件的内容替换掉，那么是否头文件中什么内容都可编写呢？答案是否。

如果头文件中编写了一个函数的函数体，那么多个.c文件包含这个.h文件的之后，会报函数重复定义的错误。

那可以在头文件中声明变量吗？

在头文件中声明的全局变量，在.h文件被包含到多个.c文件之后，就变成了这些.c文件的全局变量。C语言中.c文件是单独编译的，在编译阶段文件之间并不知道其他文件有与之冲突的全局变量，编译
能够顺利通过。但是到了链接阶段，发现多个.o文件拥有名字相同的全局变量，不知道该使用哪个。

面对同名的全局变量，链接器分情况来处理，对于全局符号，链接器分两类对待：
1. 强符号：已经初始化的全局变量、函数名；
2. 弱符号：没有初始化的全局变量。
对于变量冲突的问题，链接器根据不同的符号组合有三种处理方式:
1. 强符号之间冲突，直接报错，重复定义；
2. 弱符号与弱符号之间冲突，强符号覆盖弱符号；
3. 弱符号之间冲突，链接器自己选一个覆盖其他符号，选择方式各个编译器不同。

以上情况使用GCC亲测无误，如有错误，你再测一遍。。。

到这里，在编写头文件的时候应该注意几点，以避免不必要的错误：
1. 不要在头文件中定义变量；
2. 不准备共享的全局变量要声明成静态内部链接的变量，也就是前面加一个static；
3. 全局变量在定义时最好初始化；
4. 函数名和变量名用不同的命名方式，避免冲突；

总结一下：
1. .h文件和.c文件的文件名没有必要有联系，不必重名，为了使用和记忆方便，我们将其命名一致；
2. 不是什么东西都能够写在头文件中。

至此，思考告一段落。由于对编译器的编译过程了解的还不够深入，本文可能不够深刻甚至有些地方存在理解的错误。但是多多少少已经解决了我最开始的疑问。希望通过后续的阅读和大家友情的拍砖活动，
能够对编译器编译C程序的过程有更好的认识和理解。

###reference
<a href="http://www.cnblogs.com/rcgn/p/3203332.html" target="_blank">多文件之间的全局变量</a>
<a href="http://www.cnblogs.com/infiniti/archive/2013/03/19/2968689.html" target="_blank">C语言中头文件和源文件的关系</a>
